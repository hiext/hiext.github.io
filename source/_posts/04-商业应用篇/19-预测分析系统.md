# 第19章：预测分析系统

## 📝 本章目标
- 掌握时间序列预测
- 学习异常检测技术
- 实现需求预测系统
- 开发完整预测分析平台

## 19.1 时间序列预测

```python
from statsmodels.tsa.arima.model import ARIMA
import pandas as pd

class TimeSeriesForecaster:
    def __init__(self, order=(1,1,1)):
        self.order = order
        self.model = None
    
    def fit(self, data):
        self.model = ARIMA(data, order=self.order)
        self.fitted = self.model.fit()
        return self
    
    def forecast(self, steps=10):
        return self.fitted.forecast(steps=steps)

# 使用Prophet
from prophet import Prophet

class ProphetForecaster:
    def __init__(self):
        self.model = Prophet()
    
    def fit(self, df):
        # df需要有'ds'和'y'列
        self.model.fit(df)
    
    def predict(self, periods=30):
        future = self.model.make_future_dataframe(periods=periods)
        forecast = self.model.predict(future)
        return forecast
```

## 19.2 异常检测

```python
from sklearn.ensemble import IsolationForest

class AnomalyDetector:
    def __init__(self, contamination=0.1):
        self.model = IsolationForest(contamination=contamination)
    
    def fit_predict(self, X):
        predictions = self.model.fit_predict(X)
        # -1表示异常，1表示正常
        anomalies = X[predictions == -1]
        return anomalies

# LSTM异常检测
class LSTMAnomalyDetector:
    def __init__(self, sequence_length=10):
        self.sequence_length = sequence_length
        self.model = self._build_model()
    
    def _build_model(self):
        from tensorflow import keras
        model = keras.Sequential([
            keras.layers.LSTM(64, input_shape=(self.sequence_length, 1)),
            keras.layers.Dense(1)
        ])
        model.compile(optimizer='adam', loss='mse')
        return model
    
    def detect(self, data, threshold=0.1):
        predictions = self.model.predict(data)
        errors = np.abs(data - predictions)
        anomalies = errors > threshold
        return anomalies
```

## 19.3 销售预测系统

```python
class SalesForecastingSystem:
    def __init__(self):
        self.model = None
        self.scaler = StandardScaler()
    
    def prepare_features(self, df):
        features = pd.DataFrame()
        
        # 时间特征
        features['year'] = df['date'].dt.year
        features['month'] = df['date'].dt.month
        features['day_of_week'] = df['date'].dt.dayofweek
        features['is_weekend'] = df['date'].dt.dayofweek >= 5
        
        # 滞后特征
        features['sales_lag_1'] = df['sales'].shift(1)
        features['sales_lag_7'] = df['sales'].shift(7)
        features['sales_lag_30'] = df['sales'].shift(30)
        
        # 滚动统计
        features['sales_rolling_mean_7'] = df['sales'].rolling(7).mean()
        features['sales_rolling_std_7'] = df['sales'].rolling(7).std()
        
        return features.fillna(0)
    
    def train(self, X, y):
        from xgboost import XGBRegressor
        
        X_scaled = self.scaler.fit_transform(X)
        self.model = XGBRegressor(
            n_estimators=100,
            learning_rate=0.1,
            max_depth=5
        )
        self.model.fit(X_scaled, y)
    
    def predict(self, X):
        X_scaled = self.scaler.transform(X)
        return self.model.predict(X_scaled)
```

## 19.4 库存优化

```python
class InventoryOptimizer:
    def __init__(self, holding_cost=1, stockout_cost=10):
        self.holding_cost = holding_cost
        self.stockout_cost = stockout_cost
    
    def calculate_optimal_stock(self, demand_forecast, demand_std):
        """计算最优库存水平"""
        from scipy.stats import norm
        
        # 服务水平
        service_level = 0.95
        z_score = norm.ppf(service_level)
        
        # 安全库存
        safety_stock = z_score * demand_std
        
        # 最优订货量
        optimal_order = demand_forecast + safety_stock
        
        return {
            'optimal_order': optimal_order,
            'safety_stock': safety_stock,
            'reorder_point': demand_forecast + 0.5 * safety_stock
        }
```

## 📚 本章小结
- ✅ ARIMA/Prophet时间序列
- ✅ 异常检测算法
- ✅ 销售预测系统
- ✅ 库存优化方案

[⬅️ 上一章](./18-图像识别应用.md) | [返回目录](../README.md) | [下一章 ➡️](./20-内容生成应用.md)
