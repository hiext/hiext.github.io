# 第23章：智能金融风控系统

## 📝 项目概述

开发一个完整的金融风控系统，包含信用评分、欺诈检测、风险预警等功能。

**核心功能**：
- 💳 信用评分模型
- 🔍 欺诈检测系统
- ⚠️ 风险预警机制
- 📊 可解释AI(XAI)

## 23.1 信用评分模型

```python
import pandas as pd
import numpy as np
from sklearn.ensemble import GradientBoostingClassifier
from sklearn.model_selection import train_test_split

class CreditScoringModel:
    """信用评分模型"""
    
    def __init__(self):
        self.model = GradientBoostingClassifier(
            n_estimators=100,
            learning_rate=0.1,
            max_depth=5
        )
        self.feature_names = []
    
    def prepare_features(self, df):
        """特征工程"""
        features = pd.DataFrame()
        
        # 基础特征
        features['age'] = df['age']
        features['income'] = df['income']
        features['loan_amount'] = df['loan_amount']
        
        # 衍生特征
        features['loan_to_income'] = df['loan_amount'] / (df['income'] + 1)
        features['employment_length'] = df['employment_length']
        
        # 历史特征
        features['credit_history_length'] = df['credit_history_length']
        features['num_credit_lines'] = df['num_credit_lines']
        features['delinquency_count'] = df['delinquency_count']
        
        self.feature_names = features.columns.tolist()
        return features
    
    def train(self, X, y):
        """训练模型"""
        X_train, X_test, y_train, y_test = train_test_split(
            X, y, test_size=0.2, random_state=42
        )
        
        self.model.fit(X_train, y_train)
        
        # 评估
        train_score = self.model.score(X_train, y_train)
        test_score = self.model.score(X_test, y_test)
        
        print(f"训练集准确率: {train_score:.4f}")
        print(f"测试集准确率: {test_score:.4f}")
    
    def predict_score(self, features):
        """预测信用分数"""
        probability = self.model.predict_proba(features)[:, 1]
        score = (probability * 850 + 300).astype(int)
        return score
    
    def get_risk_level(self, score):
        """风险等级"""
        if score >= 750:
            return "优秀"
        elif score >= 700:
            return "良好"
        elif score >= 650:
            return "中等"
        else:
            return "较差"
```

## 23.2 欺诈检测系统

```python
from sklearn.ensemble import IsolationForest
from sklearn.preprocessing import StandardScaler

class FraudDetectionSystem:
    """欺诈检测系统"""
    
    def __init__(self):
        self.scaler = StandardScaler()
        self.model = IsolationForest(
            contamination=0.01,
            random_state=42
        )
    
    def extract_features(self, transaction):
        """提取交易特征"""
        features = {
            'amount': transaction['amount'],
            'hour': transaction['timestamp'].hour,
            'day_of_week': transaction['timestamp'].dayofweek,
            'location_distance': self._calculate_distance(transaction),
            'frequency_1h': self._get_frequency(transaction, hours=1),
            'frequency_24h': self._get_frequency(transaction, hours=24)
        }
        return pd.DataFrame([features])
    
    def _calculate_distance(self, transaction):
        """计算地理距离"""
        # 简化示例
        return np.random.rand() * 1000
    
    def _get_frequency(self, transaction, hours):
        """获取交易频率"""
        # 简化示例
        return np.random.randint(0, 10)
    
    def detect(self, transaction):
        """检测欺诈"""
        features = self.extract_features(transaction)
        features_scaled = self.scaler.transform(features)
        
        prediction = self.model.predict(features_scaled)
        score = self.model.score_samples(features_scaled)
        
        is_fraud = prediction[0] == -1
        risk_score = 1 / (1 + np.exp(score[0]))  # 转换为概率
        
        return {
            'is_fraud': is_fraud,
            'risk_score': risk_score,
            'risk_level': 'high' if risk_score > 0.8 else 'medium' if risk_score > 0.5 else 'low'
        }
```

## 23.3 完整风控系统

```python
class RiskControlSystem:
    """完整风控系统"""
    
    def __init__(self):
        self.credit_model = CreditScoringModel()
        self.fraud_detector = FraudDetectionSystem()
        self.alert_threshold = 0.8
    
    def evaluate_loan_application(self, application_data):
        """评估贷款申请"""
        # 信用评分
        features = self.credit_model.prepare_features(
            pd.DataFrame([application_data])
        )
        credit_score = self.credit_model.predict_score(features)[0]
        risk_level = self.credit_model.get_risk_level(credit_score)
        
        # 决策
        decision = self._make_decision(credit_score, application_data)
        
        return {
            'credit_score': int(credit_score),
            'risk_level': risk_level,
            'decision': decision,
            'approved': decision == 'approved',
            'reason': self._get_reason(credit_score, risk_level)
        }
    
    def _make_decision(self, score, data):
        """贷款决策"""
        if score >= 700:
            return 'approved'
        elif score >= 650:
            return 'manual_review'
        else:
            return 'rejected'
    
    def _get_reason(self, score, risk_level):
        """决策原因"""
        if score >= 700:
            return "信用良好，自动批准"
        elif score >= 650:
            return "需人工审核"
        else:
            return "信用分数过低"
    
    def monitor_transaction(self, transaction):
        """监控交易"""
        fraud_result = self.fraud_detector.detect(transaction)
        
        if fraud_result['is_fraud']:
            self._trigger_alert(transaction, fraud_result)
        
        return fraud_result
    
    def _trigger_alert(self, transaction, fraud_result):
        """触发警报"""
        print(f"""
        ⚠️  欺诈警报
        交易ID: {transaction.get('id', 'N/A')}
        金额: {transaction.get('amount', 0)}
        风险分数: {fraud_result['risk_score']:.2f}
        """)

# 使用示例
system = RiskControlSystem()

# 评估贷款申请
application = {
    'age': 35,
    'income': 80000,
    'loan_amount': 200000,
    'employment_length': 5,
    'credit_history_length': 10,
    'num_credit_lines': 3,
    'delinquency_count': 0
}

result = system.evaluate_loan_application(application)
print(f"信用分数: {result['credit_score']}")
print(f"决策: {result['decision']}")
```

## 23.4 可解释AI

```python
import shap

class ExplainableAI:
    """可解释AI"""
    
    def __init__(self, model):
        self.model = model
        self.explainer = shap.TreeExplainer(model)
    
    def explain_prediction(self, features):
        """解释预测结果"""
        shap_values = self.explainer.shap_values(features)
        
        # 特征重要性
        importance = pd.DataFrame({
            'feature': features.columns,
            'impact': np.abs(shap_values[0]).mean(axis=0)
        }).sort_values('impact', ascending=False)
        
        return importance
```

## 📚 本章小结
- ✅ 信用评分模型
- ✅ 欺诈检测系统
- ✅ 风险预警机制
- ✅ 完整风控流程
- ✅ 可解释AI应用

[⬅️ 上一章](./22-医疗诊断助手.md) | [返回目录](../README.md) | [下一章 ➡️](./24-智能教育平台.md)
