# 第25章：短视频内容理解系统

## 📝 项目概述
开发短视频内容理解和推荐系统，包含视频分类、内容审核、智能剪辑等功能。

## 25.1 视频分类

```python
import cv2
from tensorflow import keras

class VideoClassifier:
    def __init__(self):
        self.model = keras.applications.ResNet50(weights='imagenet')
    
    def extract_frames(self, video_path, num_frames=10):
        """提取关键帧"""
        cap = cv2.VideoCapture(video_path)
        total_frames = int(cap.get(cv2.CAP_PROP_FRAME_COUNT))
        frame_interval = total_frames // num_frames
        
        frames = []
        for i in range(num_frames):
            cap.set(cv2.CAP_PROP_POS_FRAMES, i * frame_interval)
            ret, frame = cap.read()
            if ret:
                frames.append(frame)
        
        cap.release()
        return frames
    
    def classify_video(self, video_path):
        frames = self.extract_frames(video_path)
        
        predictions = []
        for frame in frames:
            frame = cv2.resize(frame, (224, 224))
            frame = keras.applications.resnet50.preprocess_input(frame)
            pred = self.model.predict(np.expand_dims(frame, axis=0))
            predictions.append(pred)
        
        # 聚合预测结果
        avg_pred = np.mean(predictions, axis=0)
        return avg_pred
```

## 25.2 内容审核

```python
class ContentModeration:
    def __init__(self):
        self.text_classifier = pipeline("text-classification")
        self.image_classifier = pipeline("image-classification")
    
    def moderate_video(self, video_path, audio_text):
        """视频内容审核"""
        results = {
            'text_safe': True,
            'image_safe': True,
            'issues': []
        }
        
        # 文本审核
        text_result = self.text_classifier(audio_text)
        if text_result[0]['label'] == 'NEGATIVE':
            results['text_safe'] = False
            results['issues'].append('文本包含不当内容')
        
        # 图像审核
        frames = self._extract_frames(video_path)
        for frame in frames:
            img_result = self.image_classifier(frame)
            if self._is_inappropriate(img_result):
                results['image_safe'] = False
                results['issues'].append('图像包含不当内容')
                break
        
        results['approved'] = results['text_safe'] and results['image_safe']
        return results
```

## 25.3 智能剪辑

```python
class IntelligentVideoEditor:
    def __init__(self):
        pass
    
    def detect_highlights(self, video_path):
        """检测精彩片段"""
        cap = cv2.VideoCapture(video_path)
        
        highlights = []
        frame_count = 0
        motion_threshold = 5000
        
        ret, prev_frame = cap.read()
        prev_gray = cv2.cvtColor(prev_frame, cv2.COLOR_BGR2GRAY)
        
        while cap.isOpened():
            ret, frame = cap.read()
            if not ret:
                break
            
            gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)
            diff = cv2.absdiff(gray, prev_gray)
            motion_score = np.sum(diff)
            
            if motion_score > motion_threshold:
                timestamp = frame_count / cap.get(cv2.CAP_PROP_FPS)
                highlights.append({
                    'timestamp': timestamp,
                    'motion_score': motion_score
                })
            
            prev_gray = gray
            frame_count += 1
        
        cap.release()
        return highlights
    
    def auto_clip(self, video_path, target_duration=30):
        """自动剪辑"""
        highlights = self.detect_highlights(video_path)
        
        # 选择最精彩的片段
        top_highlights = sorted(
            highlights,
            key=lambda x: x['motion_score'],
            reverse=True
        )[:5]
        
        return top_highlights
```

## 25.4 视频推荐

```python
class VideoRecommender:
    def __init__(self):
        self.user_history = {}
        self.video_features = {}
    
    def extract_video_features(self, video_id, video_data):
        """提取视频特征"""
        features = {
            'category': video_data['category'],
            'tags': video_data['tags'],
            'duration': video_data['duration'],
            'view_count': video_data['view_count'],
            'like_rate': video_data['likes'] / (video_data['views'] + 1)
        }
        
        self.video_features[video_id] = features
        return features
    
    def recommend(self, user_id, n_items=10):
        """推荐视频"""
        user_watched = self.user_history.get(user_id, [])
        
        # 基于内容的推荐
        recommendations = []
        for video_id, features in self.video_features.items():
            if video_id not in user_watched:
                score = self._calculate_score(user_id, features)
                recommendations.append((video_id, score))
        
        # 排序并返回top-N
        recommendations.sort(key=lambda x: x[1], reverse=True)
        return recommendations[:n_items]
    
    def _calculate_score(self, user_id, video_features):
        # 简化的评分逻辑
        score = video_features['view_count'] * 0.3 + \
                video_features['like_rate'] * 0.7
        return score
```

## 📚 本章小结
- ✅ 视频分类与标注
- ✅ 内容审核系统
- ✅ 智能剪辑功能
- ✅ 视频推荐算法

**🎉 恭喜！您已完成全部25章的学习！**

[⬅️ 上一章](./24-智能教育平台.md) | [返回目录](../README.md)
